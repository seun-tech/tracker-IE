<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker Login</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: Arial; display:flex; justify-content:center; align-items:center; height:100vh; background:#f0f2f5; }
.login-container { background:white; padding:30px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); width:350px; text-align:center; }
.login-container h2 { margin-bottom:15px; }
.login-container input { width:100%; padding:10px; margin:5px 0; border-radius:4px; border:1px solid #ccc; }
.login-container button { padding:10px 15px; margin:5px; border:none; border-radius:4px; cursor:pointer; }
#login-btn { background:#4CAF50; color:white; width:100%; }
#signup-btn, #forgot-btn { background:#2196F3; color:white; width:48%; }
#signup-btn { margin-right:4%; }
#logout-btn { background:#f44336; color:white; width:100%; display:none; margin-top:10px; }
#user-email { margin-top:10px; color:#333; font-weight:bold; }
</style>
</head>
<body>
<div class="login-container">
  <h2>Expense Tracker</h2>
  <input type="text" id="username" placeholder="Username (for Sign Up)">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">

  <button id="login-btn">Login</button>
  <div style="display:flex; justify-content:space-between;">
    <button id="signup-btn">Sign Up</button>
    <button id="forgot-btn">Forgot Password</button>
  </div>
  
  <button id="logout-btn">Logout</button>
  <p id="user-email"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAuWm5QrnX_PJ4c6VaQaerUnZsStNAAnIU",
  authDomain: "expense-tracker-single-user.firebaseapp.com",
  projectId: "expense-tracker-single-user",
  storageBucket: "expense-tracker-single-user.firebasestorage.app",
  messagingSenderId: "58675318238",
  appId: "1:58675318238:web:7a040ad73ed4192ae5614f",
  measurementId: "G-6HJ2VH1J31"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Elements
const loginBtn = document.getElementById("login-btn");
const signupBtn = document.getElementById("signup-btn");
const forgotBtn = document.getElementById("forgot-btn");
const logoutBtn = document.getElementById("logout-btn");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const usernameInput = document.getElementById("username");
const userEmailEl = document.getElementById("user-email");

// LOGIN
loginBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    // Fetch username from Firestore
    const docSnap = await getDoc(doc(db, "users", user.uid));
    if(docSnap.exists()){
      localStorage.setItem("username", docSnap.data().username); // store for dashboard
    }
    alert("Login successful!");
    window.location.href = "app.html"; // redirect
  } catch (err) {
    alert("Login failed: " + err.message);
  }
});

// SIGN UP
signupBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  const password = passwordInput.value;
  const username = usernameInput.value || email.split("@")[0]; // default username from email
  if(!email || !password) { alert("Email and Password required"); return; }
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    // Save username in Firestore
    await setDoc(doc(db, "users", user.uid), { username, email });
    localStorage.setItem("username", username);
    alert("User created and logged in!");
    window.location.href = "app.html"; // redirect
  } catch (err) {
    alert("Sign Up failed: " + err.message);
  }
});

// FORGOT PASSWORD
forgotBtn.addEventListener("click", async () => {
  const email = emailInput.value;
  if(!email){ alert("Enter your email for password reset."); return; }
  try {
    await sendPasswordResetEmail(auth, email);
    alert("Password reset email sent!");
  } catch (err) {
    alert("Error: " + err.message);
  }
});

// LOGOUT
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  alert("Logged out!");
});

// Optionally: display logged-in user (if page kept open)
onAuthStateChanged(auth, user => {
  if(user){
    loginBtn.style.display = "none";
    signupBtn.style.display = "none";
    forgotBtn.style.display = "none";
    logoutBtn.style.display = "block";
  } else {
    loginBtn.style.display = "block";
    signupBtn.style.display = "block";
    forgotBtn.style.display = "block";
    logoutBtn.style.display = "none";
  }
});
</script>
</body>
</html>
